# 08. 통합 테스트를 하는 이유

## 통합 테스트

### 통합 테스트의 역할

프로세스 외부 의존성과 통합해 어떻게 작동하는지를 검증한다.

> - 단일 동작 단위를 검증
>- 빠르게 수행
>- 다른 테스트와 별도 처리

- 단점
    - 프로세스 외부 의존성에 직접 작동하기에 속도가 느려진다.
    - 외부 의존성에 대한 운영이 필요하여 유지비가 늘어난다.
    - 관련된 협력자가 많아져서 테스트 코드 양이 증가한다.
- 장점
    - 회귀방지와 리팩터링 내성이 우수하다.

### 단위 테스트와 통합 테스트 관계

단위 테스트는 빠르고 저렴하기 때문에 가능한 한 많이 비즈니스 시나리오의 예외상황을 확인한다.    
통합 테스트는 느리고 개수가 적지만 주요 흐름과 기타 예외 사항을 검증하여 시스템 전체의 정확도를 보장한다.  
통합 테스트에서 프로세스 외부 의존성과의 상호작용을 모두 확인하려면 가장 긴 주요 흐름을 선택한다.

![09_Test_Pyramid.png](09_Test_Pyramid.png)

### 프로세스 외부 의존성

- 관리 의존성
    - 전체를 제어할 수 있는 프로세스 외부 의존성
    - 애플리케이션을 통해서만 접근 가능하며, 해당 의존성과 상호작용은 외부 환경에서 확인 붙가능
    - 외부 시스테은 직접 접근하지 않고 애플리케이션에서 제공하는 API 를 통해 접근한다.
    - ex.) 데이터베이스
- 비관리 의존성
    - 전페를 제어할 수 없는 프로세스 외부 의존성
    - 의존성 과의 상호 작용을 외부에서 확인 가능
    - SMTP 메일 서버와 Message Bus

> 테스트 관점에서 관리 의존성은 실제 인스턴스를 사용하고, 비관리 의존성을 목으로 대체한다.

> # 관리 의존성 이면서, 비관리 의존성인 프로세스 외부 의존성
> 공유 데이터베이스 혹은 캐시 서버와 같이 여러 시스템에서 공통으로 쓰는 외부 의존성

![10_Test_Octagon_Integaration.png](10_Test_Octagon_Integaration.png)

## 통합 테스트 모범 사례

### 도메인 경계 명시

도메인 클래스와 컨트롤러 사이의 경계를 명확히 하여 테스트의 구분이 용이하다.

### 계층 수 줄이기

추상 계층이 너무 많으면 코드 베이스를 탐색 하기 어렵다.

### 순환 의존성 최소화

동작 단위를 분리 하기 어려우면 테스트 작성에 어려움을 격는다.
> # 순환 의존성 ( Circular Dependency 0)
> 돌 이상의 클래스가 제대로 작동하고자 직간접적으로 서로 의존

### 테스트에서 다중 실행 구성

테스트에서 두 개 이상의 준비나 실행, 검증 구절을 두는 것을 *Code Smell* 이다.    
프로세스 외부 의존성을 만들기 어려운 경우를 제외 하고는 테스트는 하나의 실행에 하나의 검증으로 구성한다.    
( 프로세스 외부 의존성에 대한 상호 작용을 하나로 간략화 )

## Log Function Test

### Required Logging Test

- 로깅은 횡단 기능(Cross-Cutting Functionality) 로 코드 베이스 어디에서나 필요하다.
- 아래 2가지 로그 중에서 지원 로깅은 시스템의 한 기능으로서 구현 세부 사항으로 테스트 대상에 포함 될 수 있다.
    - 지원 로깅 ( Support Logging ) : 지원 담당자나 시스템 관리자가 추적할 수 있는 메세지
    - 진단 로깅 ( Diagnostic Logging ) : 개발자가 App. 내부상황을 파악 할 수 있도록 돕는 메세지

### How to Logging Test

- 로깅은 아래와 같은 프로세스 외부 의존성이 있다.
    - Console Log 출력
    - Database 입력
    - ElasticSearch 등 Logging 시스템 입출력
    - Log File 생성
- App. 과 Log 저장소 간의 상호 작용을 검증하기 위해 Mock 을 사용한다.
    - ILogger 의 Wrapper 도입
    - 구조화된 로깅(Structured Logging) 도입 ( 로그 데이터와 렌더링 과정 분리 )

### How much Logging

- 도메인 모델에서는 과도한 로깅은 지양한다. 로그가 많을수록 관련 정보를 찾기가 어려워진다. ( 모래 위에 바늘 찾기 )

### Delivery Logging

- 로그의 전달은 명시적으로 이루어 져야 한다. ( Method 의 인수 또는 Class 의 생성자를 통해서 )~~