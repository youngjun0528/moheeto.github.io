# 05. 목과 테스트 취약성
## Test Fixture ( 테스트 픽스쳐 )

- 테스트 실행 대상 객체
- 각 테스트의 일관된 결과값을 리턴해 주기 위한 정규 의존성을 가진 객체(데이터 베이스, 설정 파일 등)

## Test Double ( 테스트 대역 )

- 하나의 클래스의 다른 또는 여러 클래스 의존성을 분리하기 위해 작성된 가상의 객체
- Test Fixture 객체를 만들기 위해서 Test Double 을 사용하여 테스트 케이스를 작성

### Mock ( 목 )

- 외부로 나가는 상호 작용을 모방
    - 명령을 대체하는 테스트 대역 ( 즉 행동을 검증 )
    - 즉, 다른 시스템으로의 호출이 정상적으로 이루어 졌는가?
    - 메일 시스템으로 메일링이 가능한가?
- Mock Framework 을 사용하여 만든 객체

> # 도구로서의 Mock 과 테스트 대역으로서의 Mock
> 도구로 사용하는 Mock 은 Mock 라이브러리를 의미한다. Mock Lib.는 테스트 대역인 Mock 과 Stub 을 작성할 수 있다.

### Spy ( 스파이 )

- Mock 과 유사하지만, 수동으로 직접 작성한다.

### Stub ( 스텁 )

- 내부로 들어오는 상호 작용을 모방
    - 조회를 대체하는 테스트 대역 ( 즉 상태를 검증 )
    - 즉, 다른 시스템으로부터 데이터를 정상 수신 처리 할 수 있는가?
    - 데이터베이스의 데이터를 정상 조회 할 수 있는가?
- 시나리오 마다 다른 값을 반환 하도록 구성하는 완전한 의존성 객체

### Dummy ( 더미 )

- NULL 또는 임의의 몬자열과 같이 하드 코딩된 값

### Fake ( 페이크 )

- 아직 존재하지 않은 의존성을 대체 ( 미구현된 Class 또는 구축되지 않은 데이터베이스 )

## Conclusion

![03_Test_Mock.png](03_Test_Mock.png)

- 대상 시스템을 테스트 하고자 할 때, 조회와 명령을 테스트 할 수 있다.
- 명령을 테스트 하는 경우, Side-Effect( 객체의 상태 변경, 파일 시스템 내 파일 변경 등) 을 발생시키고, 그 반환 값이 없다.
    - 위 예제에서 명령으로 메일 서버에 메일을 발송하는 경우 메일의 상태가 변경되지만, 그로 인한 반환 값은 없다.
    - 이 명령을 Patching 하는 것이 Mock 이다.
    - 실제 메일 서버를 통해서 메일을 보내지 않지만, 모의 객체를 통해서 메일 발송 기능의 로직을 점검 할 수 있다.
- 조회를 테스트 하는 경우, Side-Effect가 없지만, 결과값이 존재한다.
    - 위 예제에서 조회로 데이터베이스를 조회하는 경우, RDS의 데이터가 변경되지 않지만, 반환 값은 있다.
    - 이 조회를 Patching 하는 것이 Stub 이다.
    - 실제 RDS 에 접근하여 데이터를 조회하지 않지만, 모의 객체를 통해서 임의의 데이터를 반환하여 준다.

> # Patching ( Mocking )
> 테스트 수행시 외부 서비스를 직접 Access 하지 않고 중간에 모의 객체를 통해서 가로채는 과정을 Patching 또는 Mocking 이라 한다.

> # 결론
> - Mock 과 Stub은 테스트 철학과 관계된 내용으로 이 둘을 구분하는 것은 어렵다.
> - Mock 은 테스트 하고자 하는 대상이 정상적으로 호출이 이루어 졌는지 호출 대상을 모방
>   - 의존성 분리를 Mock으로 호출 행위를 검증
> - Stub 은 테스트 하고자 하는 대상이 정상적으로 호출이 되었다는 가정으로 호출대상을 모방
>   - 의존성 분리를 Stub으로 호출이 되었다는 가정한 상태를 검증
> - 대부분의 테스트 라이브러리들은 Mock 과 Stub 을 적절히 섞어서 제공한다.
> - Java의 Mockito 를 쓰든, Python moto 를 쓰든 Mock, Stub 이 공존하고 있다.
>   - Mock 이 Stub 역할을 대체하는 경우도 많다. Mock 과 Stub 으롤 대체한다는 용어로 Mocking ( 모킹 ) 한다는 말을 주로 한다.
> - 테스트 대상이 정상적으로 작동이 되는지 보기 위해서 Mock 테스트 라이브러리들을 사용하던지, 임의의 객체를 생성하는 Stub 을 사용할 것인지 결정한다.

## 육각형 아키텍처에서의 테스트 관점

### 도메인 계층과 서비스 계층 간의 관심사 분리

- 도메인 계층은 해당 비즈니스 로직에 대한서만 책임
- 외부 서비스와의 통신은 서비스 계층에서 책임

### 애플리케이션 내부 통신

- 애플리케이션 서비스 계층에서 도메인 계층으로 흐르는 단방향 의존성 흐름

### 애플리케이션 간의 외부 통신

- 외부 서비스는 애플리케이션 서비스 계층에 있는 공통 인터페이스를 통해서 접근한다.

### 테스트

![04_Test_Octagon.png](04_Test_Octagon.png)

- 외부 서드파티 시스템의로부터 성공 여부는 Stub 으로 작성하여 반환 값을 받아서 애플리케이션 내부에서 로직 수행을 검증한다.
- SMTP 메일 서비스의 메일 발송 여부는 Mock 으로 작성하여 메일이 발송되었다고 가정하고 로직을 점검한다.
- 모든 외부 의존성을 Mock으로 처리할 필요는 없다.
- Mock 은 애플리케이션의 경계를 넘어서 상호 작용의 동작을 검증한다. 애플리케이션의 내부에 있는 의존성까지 Mock 으로 처리하지 않아도 된다.
