# 10. 데이터베이스 테스트

## 전제 조건

1. 형상 관리 시스템에 데이터베이스 유지
    - 데이터베이스 스키마를 일반 코드로 취급하여 관리한다.
    - 데이터베이스의 SQL 구문을 별도 파일 저장 + ORM 으로 데이터베이스 스키마 정의 => VCS ( 버전 관리 시스템 )
2. 모든 개발자를 위한 별도의 데이터베이스 인스턴스 사용
    - Local 에 개발자를 위한 별도의 데이버베이스 인스턴스 설치가 필요
        - 서로 다른 개발자가 실행한 테스트가 서로 간섭
        - 하위 호환성이 없는 변경으로 다른 개발자의 작업 방해
3. 데이터베이스 배포에 방식 구분
    - 상태 기반 방식
        - RDS의 상태를 형상관리에 저장함으로써 상태를 명시하고 비교 도구를 활용하여 암묵적인 마이그레이션 작업을 진행한다.
        - ![11_Test_Database_status.png](11_Test_Database_status.png)
    - 마이그레이션 기반 방식
        - 마이그레이션 코드를 형상관리에 저장하여 명시적이지만, 전체 데이터베이스 상태는 암묵적이다.
        - 데이터 모션 용이성(데이터 형태 변경)과 병합 충돌 완화에 도움이 된다.
        - ![12_Test_Database_migration.png](12_Test_Database_migration.png)

## 트랜잭션 관리

1. 트랜잭션과 연결 분리
    - 데이터베이스 연결 과정과 데이터를 변경 처리하는 트랩잭션은 별도 구현하여 처리한다.
    - 수명 주기가 다름.
2. 작업단위 트랜잭션으로 분리
    - 하나의 작업이 하나의 트랜잭션이 갖도록 하여 업무 단위로 데이터 운영이 가능하도록 처리
    - 통합테스트 에서는 적어도 3개의 트랜잭션 또는 작업단위 ( 준비, 실행, 검증 )를 사용하라.

> # 비관계형 데이터베이스에서의 데이터 모순
> 대부분의 비 관계형 데이터베이스는 고전적인 의미에서 트랜잭션이 없다.  
> 원자적 업데이트는 단일 Document ( *관계형 데이터베이스 에서는 행 Row* ) 내에서만 보장된다. 비즈니스 연산이 여러 문서에 영향을 주는 경우 모순이 생기기 쉽다.
>
> 한번에 둘 이상의 도큐먼트를 수정하는 연산이 없도록 설계한다.
>
{style="note"}

## 테스트 데이터 생명 주기

### 데이터 정리

1. 각 테스트 전에 데이터베이스 백업 복원
    - 테스트 실행 시간 증가
2. 테스트 종료 시점에 데이터 정리
    - 테스트가 중간에 멈추거나, 오류 발생시 더미 데이터로 인한 다른 테스트에 영향 발생
3. 데이터베이스 트랜잭션에 각 테스트를 래핑하고 커밋하지 않기
    - 추가 트랜잭션에 의한 운영 환경과 다른 설정 생성
4. 테스트 시작 시점에 데이터 정리하기
    - 테스트 일관성 유지에 가장 좋은 방법

### 테스트 데이터베이스 선정

1. Container 로 구성된 데이터베이스 방식
    - 장점 : 병렬 처리에 효과적
    - 단점 : 속도가 느리고, 컨테이너 이미지 유지보수, 각 테스트마다 컨테이너 확인, 컨테이너 생명주기 확인이 필요한 단점이 존재

2. In-Memory 데이터베이스 방식 ( ex. SQlite)
    - 장점 : 테스트 데이터 수명주기 무시, 작업 속도 향상, 컨테이너와 유사한 방식
    - 단점 : 실제 운영 데이터 베이스와의 설계 차이로 인한 테스트 실패 확률 증가

## 일반적인 질문

### Read Test 여부

읽기 에는 추상화 계층이 거의 없고, 중요한 읽기 작업에 의한 비즈니스 영역을 제외하고는 오류의 비용이 낮기 때문에 통합 테스트가 중요하다.

### Repository Test 여부

ORM Repository Entity 의 경우, 복잡도가 거의 없고, 프로세스 외부 의존성과 통신하는 컨트롤러 영역이다.  
포괄적인 통합 테스트 영역에서 더 중요하다.   
    